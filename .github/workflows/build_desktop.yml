name: Build Desktop Apps

on:
    push:
        branches: ["main"]
    workflow_dispatch:

jobs:
    build:
        strategy:
            matrix:
                os: [windows-latest, macos-latest, ubuntu-latest]

        runs-on: ${{ matrix.os }}

        steps:
            - uses: actions/checkout@v3

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.11"

            - name: Install Linux Dependencies
              if: matrix.os == 'ubuntu-latest'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libgstreamer-plugins-bad1.0-dev gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly gstreamer1.0-libav gstreamer1.0-tools gstreamer1.0-x gstreamer1.0-alsa gstreamer1.0-gl gstreamer1.0-gtk3 gstreamer1.0-qt5 gstreamer1.0-pulseaudio

            - name: Install Python Dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements_mobile.txt
                  pip install pyinstaller

            - name: Prepare Assets (Cross-Platform)
              shell: bash
              run: |
                  # Create a dummy icon if it doesn't exist to prevent errors
                  mkdir -p assets
                  if [ ! -f assets/icon.png ]; then touch assets/icon.png; fi

            - name: Build with PyInstaller (Windows)
              if: matrix.os == 'windows-latest'
              run: |
                  pyinstaller downmess_mobile.py --name "Downmess" --onefile --noconsole --icon "assets/icon.png" --add-data "assets;assets"

            - name: Build with PyInstaller (Mac/Linux)
              if: matrix.os != 'windows-latest'
              run: |
                  pyinstaller downmess_mobile.py --name "Downmess" --onefile --noconsole --add-data "assets:assets"

            - name: Upload Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: downmess-${{ matrix.os }}
                  path: dist/*
